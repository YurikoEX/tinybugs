<!DOCTYPE html>
<html lang="en">
<head>
  <title>tinyBugs - Post New Issue</title>
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<!--  <link href="//netdna.bootstrapcdn.com/bootswatch/2.3.2/united/bootstrap.min.css" rel="stylesheet">-->
</head>
<body>
<div class="container">
  <div class="row">
  <div class="span12">
  <form id='bugForm' method='post'>
    <fieldset>
    <legend>New Issue</legend>

    <label for='title'>Title</label>
    <input id='title' name='title' type='text' maxlength='140' value="{{title}}" placeholder="required" required='required' class="span8" />

    <label for='type'>Details</label>
    <div class="mdd_toolbar"></div>
    <textarea id='text' name='text' rows='5' class='span8 mdd_editor' required='required' placeholder="required">{{text}}</textarea>
    <div class="mdd_resizer"></div>

    <div class="controls controls-row">
        <label for='type' class="span2">Type</label>
        <label for='release' class="span2">Release</label>
        <label for='assignto' class="span3">Assign To</label>
    </div>
    <div class="controls controls-row">
        <select id='type' name='type' class="span2">
          <option value='Bug'>bug</option>
          <option value='Feature'>feature</option>
        </select>
        <select id='release' name='release' class="span2">
          <option value='v4.x'>v4.x</option>
          <option value='v3.x'>v3.x</option>
        </select>
        <input id='assignto' name='assignto' type='text' class="typeahead span3"
               data-provide="typeahead" autocomplete="off" />
    </div>

    <label for='tags'>Tags</label>
    <input id='tags' name='tags' type='text' value="{{tags}}" />

    <label for='private' class="checkbox">
      <input id='private' name='private' type='checkbox' />Private
      <span class="help-inline">(only you and administrators can see the bug)</span>
    </label>

    <input type="hidden" value="{{id}}" id="id" name="id" />

    <div id="bugerror" class="alert alert-error hide">
      <button type="button" class="close">&times;</button>
      <strong>Error!</strong> Something went awry while submitting your changes. Please, try again.
    </div>

    <div class="form-actions">
      <button id='savebug' type="submit" class="btn btn-primary" data-loading-text="Saving...">Save changes</button>
      <a href="/" class="btn">Cancel</a>
    </div>
    </fieldset>
  </form>
  </div>
  </div>
  <div id="message"></div>
  <div id="loginModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <form id='loginForm' method='post'>
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3 id="loginHeader">Login</h3>
    </div>
    <div id="loginerror" class="alert alert-error hide">
      <button type="button" class="close">&times;</button>
      <strong>Error!</strong> Invalid username/email or password. Please, try again.
    </div>
    <div class="modal-body">
        <label for='username'>Username</label>
        <input id='username' name='username' type='text' placeholder="username or email" required='required' />
        <label for='password'>Password</label>
        <input id='password' name='password' type='password' required='required' />
    </div>
    <div class="modal-footer">
        <button id='attemptlogin' type="submit" class="btn btn-primary" data-loading-text="Logging in...">Submit</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
    </form>
  </div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout/2.3.0/knockout-min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="/js/tinybugs.js"></script>
<script>
$(document).ready(function () {
    $('#assignto').typeahead({
        source: ["foo@example.com", "bar@example.com"]
        //matcher: function (item) {
        //    return this.query == item;
        //}
    });

    $('#bugForm').submit(function (e) {
        var submit = $(this).find(':submit').button('loading');
        var alert = $(this).find('.alert').slideUp('fast');

        e.preventDefault();
        $.post('api/{{id}}', $(this).serialize())
            .done( function(data) {
                // TODO: send the user off to view their bright shiny new bug based on the "data".
            }).fail(function (jqXHR, textStatus, errorThrown) {
                if (errorThrown === 'Unauthorized') {
                    $('#loginModal').modal();
                }
                else {
                    alert.slideDown();
                }
            }).always(function () {
                $('#savebug').button('reset');
            });
    });

    $('#loginModal').on('hide', function () {
        $(this).find('.alert').hide();
    });

    $('#loginForm').submit(function (e) {
        var submit = $(this).find(':submit').button('loading');
        var alert = $(this).find('.alert').slideUp('fast');

        e.preventDefault();
        $.post('login/', $(this).serialize())
            .done(function () {
                $('#loginModal').modal('hide');
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert.slideDown();
            }).always(function () {
                submit.button('reset');
            });
    });

    $(".alert").find(".close").on("click", function (e) {
        e.stopPropagation();
        e.preventDefault();
        $(this).closest(".alert").slideUp();
    });

    var dirty = false;

    $(':input').change(function () {
        dirty = true;
    });

    window.onbeforeunload = function (e) {
        if (dirty) {
            var message = "There are edits to this bug report.";
            e = e || window.event;
            if (e) {
                e.returnValue = message; // IE and Firefox support
            }

            return message; // Safari support
        }
    };
});
</script>
</html>
