<!DOCTYPE html>
<html lang="en">
<head>
  <title>{{app.name}} - #{{issue.id}} | {{issue.title}}</title>
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
  <link href="{{app.path}}assets/css/tinybugs.css" rel="stylesheet" />
</head>
<body>
<div class="container">
  {{#breadcrumbs}}
  <div class="row">
    <div class="span9">
    <ul class="breadcrumb">
    {{#parents}}<li><a href="{{url}}">{{title}}</a> <span class="divider">/</span></li>{{/parents}}
    {{#current}}<li class="active">{{title}}</li>{{/current}}
    </ul>
    </div>
  </div>
  {{/breadcrumbs}}
  <div class="row">
  <div class="span9">
    {{#issue}}
    <h3><small>{{type}} {{id}} |</small> {{title}}</h3>
    <div class="row">
    <div class="span7">
    {{#private}}<span class="label label-important">Private</span>{{/private}}
    <span class="label label-info">{{status}}</span>
    {{#resolution}} <span class="label label-info">{{resolution}}</span>{{/resolution}}
    <span class="label label-success">{{release}}</span>
    <span class="label label-inverse">{{area}}</span>
    <span class="badge label-warning">{{votes}}</span>
    <div class="btn-group pull-right">
      <a href="{{app.path}}edit/{{id}}" class="btn btn-mini">Edit issue</a>
      <a href="{{app.path}}edit/{{id}}" class="btn btn-mini">Quick edit</a>
    </div>
    </div></div>
    <p>Opened <span data-toggle='tooltip' title="{{createdrelative.friendly}}">{{createdrelative}}</span> by {{createdbyusername}}</p>
    <p>Last updated <span data-toggle='tooltip' title="{{updatedrelative.friendly}}">{{updatedrelative}}</span></p>
    <p>Assigned to: {{assignedtousername}}{{^assignedtousername}}No one <input id="takeit" type="button" class="btn btn-mini" data-loading-text="acquiring..." value="take it!" />{{/assignedtousername}}</p>

    <h4>Details</h4>
    <p>{{{textrendered}}}</p>

    {{#comments}}
      <p>Comment from {{commentbyusername}} <span data-toggle='tooltip' title="{{createdrelative.friendly}}">{{createdrelative}}</span></p>
      <p>{{{textrendered}}}</p>
    {{/comments}}
    {{/issue}}
  </div>
  </div>
  {{> modal_login.mustache }}
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="{{app.path}}assets/js/tinybugs.js"></script>
<script>
$(document).ready(function () {
    $('#assignto').typeahead({
        source: function (query, process) {
            var url = $(this.$element).attr('data-url');
            return $.get(url, { q: query }, function (data) {
                return process(data);
            });
        },
        //matcher: function (item) {
        //    return this.query == item;
        //}
    });

    $('#takeit').on('click', function (e) {
      var takeitButton = $('#takeit').button('loading');

      $.post('{{app.path}}api/issue/{{id}}', 'assignedto=[me]')
          .done(function(data) {
            location.reload();
          }).fail(function (jqXHR, textStatus, errorThrown) {
            if (errorThrown === 'Bad Gateway') {
              $('#loginModal').modal();
            }
            else {
              alert.slideDown();
            }
          }).always(function () {
            takeitButton.button('reset');
          });
    });

    $('#bugForm').submit(function (e) {
        var submit = $(this).find(':submit').button('loading');
        var alert = $(this).find('.alert').slideUp('fast');

        e.preventDefault();
        $.post('{{app.path}}api/issue/{{id}}', $(this).serialize())
            .done( function(data) {
                // TODO: send the user off to view their bright shiny new bug based on the "data".
            }).fail(function (jqXHR, textStatus, errorThrown) {
                if (errorThrown === 'Bad Gateway') {
                    $('#loginModal').modal();
                }
                else {
                    alert.slideDown();
                }
            }).always(function () {
                $('#savebug').button('reset');
            });
    });
});
</script>
</body>
</html>
