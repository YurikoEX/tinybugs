<!DOCTYPE html>
<html lang="en">
<head>
  <title>{{app.name}} - #{{issue.id}} | {{issue.title}}</title>
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
  <link href="{{app.path}}assets/css/tinybugs.css" rel="stylesheet" />
</head>
<body>
<div class="container">
  {{#breadcrumbs}}
  <div class="row">
    <div class="span12">
    <ul class="breadcrumb">
    {{#parents}}<li><a href="{{url}}">{{title}}</a> <span class="divider">/</span></li>{{/parents}}
    {{#current}}<li class="active">{{title}}</li>{{/current}}
    </ul>
    </div>
  </div>
  {{/breadcrumbs}}
  {{#issue}}
  <div class="row">
  <div class="span12">
    <h3><small>{{type}} {{id}} |</small> {{title}}</h3>
  </div>
  </div>
<!--  <div class="row">
  <div class="span11">
    {{#private}}<span class="label label-important">Private</span>{{/private}}
    <span class="label label-info">{{status}}</span>
    {{#resolution}} <span class="label label-info">{{resolution}}</span>{{/resolution}}
    <span class="label label-success">{{release}}</span>
    <span class="label label-inverse">{{area}}</span>
    <span class="badge label-warning">{{votes}}</span>
    <div class="btn-group pull-right">
      <a href="{{app.path}}edit/{{id}}" class="btn btn-mini">Edit issue</a>
      <a href="{{app.path}}edit/{{id}}" class="btn btn-mini">Quick edit</a>
    </div>
  </div>
  </div>-->
<!--  <div class="row">
  <div class="span12">
    <p>&nbsp;</p>
  </div>
  </div>-->
  <div class="row">
  <div class="span12">
<!--    <div class="well well-small">
    <div class="row">
    <div class="span4">
    <p><small>Assigned to</small> <strong><a href="#">{{assignedtousername}}</a>{{^assignedtousername}}No one <input id="takeit" type="button" class="btn btn-mini" data-loading-text="acquiring..." value="take it!" />{{/assignedtousername}}</strong></p>
    </div>
    <div class="span5">
    <p><small>Opened by</small> <strong><a href="#">{{createdbyusername}}</a></strong> <small>on</small> <strong>{{createdrelative.date}} @ {{createdrelative.time}}</strong></p>
    </div>
    <div class="span2">
    <p><small>Last updated</small> <strong>{{updatedrelative.date}}</strong> <small>@</small> <strong>{{updatedrelative.time}}</strong></p>
    </div>
    </div>
  </div>
-->
    <table class="table table-hover table-striped">
    <tr>
    <td>{{#private}}<span class="label label-important">Private</span>{{/private}}
    <span class="label label-info">{{status}}</span>
    {{#resolution}} <span class="label label-info">{{resolution}}</span>{{/resolution}}
    <span class="label label-success">{{release}}</span>
    <span class="label label-inverse">{{area}}</span>
    <span class="badge label-warning">{{votes}}</span>
</td>
    <td><small>Assigned to</small> <strong><a href="#">{{assignedtousername}}</a>{{^assignedtousername}}No one <input id="takeit" type="button" class="btn btn-mini" data-loading-text="acquiring..." value="take it!" />{{/assignedtousername}}</strong></td>
    <td><small>Updated</small> <strong>{{updatedrelative.date}}</strong> <small>@</small> <strong>{{updatedrelative.time}}</strong></td>
    <td><small>Opened</small> <strong>{{createdrelative.date}}</strong> <small>@</small> <strong>{{createdrelative.time}}</strong> <small>by</small> <strong><a href="#">{{createdbyusername}}</a></strong></td>
    </tr></table>
    </div>
  </div>

  <div class="row">
  <div class="span12">
    <div class="btn-group pull-right">
      <a href="{{app.path}}edit/{{id}}" class="btn btn-mini">Edit issue</a>
      <a href="{{app.path}}edit/{{id}}" class="btn btn-mini">Quick edit</a>
    </div>
  </div>
  </div>
  <div class="row">
  <div class="span12">
    <strong>{{title}}</strong>
    <p>{{{textrendered}}}</p>
  </div>
  </div>

  <div class="row">
  <div class="span11 form-actions">
  <input id="addcomment" type="button" class="btn btn-success" value="Add a Comment" />
  </div>
  </div>

  <div class="row">
  <div class="span10">
  {{#comments}}
  <div class="row">
  <div class="span10">
    <table class="table table-hover">
    <tr>
    <td>
    {{#text}}
    <small>Comment from</small> <strong><a href="#">{{commentbyusername}}</a></strong>
        <strong>{{createdrelative.date}}</strong> <small>@</small> <strong>{{createdrelative.time}}</strong> <!--<small>by</small> <strong><a href="#">{{createdbyusername}}</a></strong>-->
    {{/text}}
    {{^text}}
    <small>Edited by</small> <strong><a href="#">{{commentbyusername}}</a></strong>
        <strong>{{createdrelative.date}}</strong> <small>@</small> <strong>{{createdrelative.time}}</strong> <!--<small>by</small> <strong><a href="#">{{createdbyusername}}</a></strong>-->
    {{/text}}
    <ul class="inline">
    {{#changes}}
    <li><code>{{column}}</code> {{#old}}changed from <code>{{old}}</code>{{/old}}{{^old}}set{{/old}} to {{#new}}<code>{{new}}</code>{{/new}}{{^new}}blank{{/new}}</li>
    {{/changes}}
    </ul>
    </td>
    </tr>
    </table>
    {{{textrendered}}}
  </div>
  </div>
  {{/comments}}
  {{^comments}}
  <p>No comments.</p>
  {{/comments}}
  </div>
  </div>
  {{/issue}}

  {{> modal_login.mustache }}
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="{{app.path}}assets/js/tinybugs.js"></script>
<script>
$(document).ready(function () {
    $('#assignto').typeahead({
        source: function (query, process) {
            var url = $(this.$element).attr('data-url');
            return $.get(url, { q: query }, function (data) {
                return process(data);
            });
        },
        //matcher: function (item) {
        //    return this.query == item;
        //}
    });

    $('#takeit').on('click', function (e) {
      var takeitButton = $('#takeit').button('loading');

      $.post('{{app.path}}api/issue/{{id}}', 'assignedto=[me]')
          .done(function(data) {
            location.reload();
          }).fail(function (jqXHR, textStatus, errorThrown) {
            if (errorThrown === 'Bad Gateway') {
              $('#loginModal').modal();
            }
            else {
              alert.slideDown();
            }
          }).always(function () {
            takeitButton.button('reset');
          });
    });

    $('#bugForm').submit(function (e) {
        var submit = $(this).find(':submit').button('loading');
        var alert = $(this).find('.alert').slideUp('fast');

        e.preventDefault();
        $.post('{{app.path}}api/issue/{{id}}', $(this).serialize())
            .done( function(data) {
                // TODO: send the user off to view their bright shiny new bug based on the "data".
            }).fail(function (jqXHR, textStatus, errorThrown) {
                if (errorThrown === 'Bad Gateway') {
                    $('#loginModal').modal();
                }
                else {
                    alert.slideDown();
                }
            }).always(function () {
                $('#savebug').button('reset');
            });
    });
});
</script>
</body>
</html>
