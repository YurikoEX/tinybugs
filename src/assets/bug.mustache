<!DOCTYPE html>
<html lang="en">
<head>
  <title>tinyBugs - Issue {{id}}</title>
  {{> header}}
</head>
<body>
<div class="container">
  <div class="row">
  <div class="span12">
    <h3><small>{{type}} {{id}}</small> {{title}}</h3>

    <p>Details</p>
    <p>{{{textrendered}}}</p>

    <p>Release</p>
      <p>{{release}}</p>
      <p>Assigned to</p>
      <p>{{assignto}}</p>

    <p>Tags</p>
      <p>{{tags}}</p>

      <p>Private</p>
      <p>{{private}}</p>

      <p>Votes</p>
      <p>{{votes}}</p>

    <form id='bugForm' method='post'>
    <fieldset>
    <legend>New Issue</legend>

    <input type="hidden" value="{{id}}" id="id" name="id" />

    <div id="bugerror" class="alert alert-error hide">
      <button type="button" class="close">&times;</button>
      <strong>Error!</strong> Something went awry while submitting your changes. Please, try again.
    </div>

    <div class="form-actions">
      <button id='savebug' type="submit" class="btn btn-primary" data-loading-text="Saving...">Save changes</button>
      <a href="/" class="btn">Cancel</a>
    </div>
    </fieldset>
  </form>
  </div>
  </div>
  <div id="message"></div>
  <div id="loginModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <form id='loginForm' method='post'>
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3 id="loginHeader">Login</h3>
    </div>
    <div id="loginerror" class="alert alert-error hide">
      <button type="button" class="close">&times;</button>
      <strong>Error!</strong> Invalid username/email or password. Please, try again.
    </div>
    <div class="modal-body">
        <label for='username'>Username</label>
        <input id='username' name='username' type='text' placeholder="username or email" required='required' />
        <label for='password'>Password</label>
        <input id='password' name='password' type='password' required='required' />
    </div>
    <div class="modal-footer">
        <button id='attemptlogin' type="submit" class="btn btn-primary" data-loading-text="Logging in...">Submit</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
    </form>
  </div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="/js/tinybugs.js"></script>
<script>
$(document).ready(function () {
    $('#assignto').typeahead({
        source: function (query, process) {
            var url = $(this.$element).attr('data-url');
            return $.get(url, { q: query }, function (data) {
                return process(data);
            });
        },
        //matcher: function (item) {
        //    return this.query == item;
        //}
    });

    $('#bugForm').submit(function (e) {
        var submit = $(this).find(':submit').button('loading');
        var alert = $(this).find('.alert').slideUp('fast');

        e.preventDefault();
        $.post('api/{{id}}', $(this).serialize())
            .done( function(data) {
                // TODO: send the user off to view their bright shiny new bug based on the "data".
            }).fail(function (jqXHR, textStatus, errorThrown) {
                if (errorThrown === 'Unauthorized') {
                    $('#loginModal').modal();
                }
                else {
                    alert.slideDown();
                }
            }).always(function () {
                $('#savebug').button('reset');
            });
    });
});
</script>
</body>
</html>
